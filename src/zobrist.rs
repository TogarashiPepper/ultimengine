use crate::{
    bitboard::consts::{O_MASK, O_OFFS, X_MASK},
    board::Slot,
    game::Game,
};

#[derive(Debug)]
pub struct ZobristBuilder {
    pieces_x: [[u64; 9]; 9],
    pieces_o: [[u64; 9]; 9],
    active: [u64; 10],
    x_turn: u64,
}

pub static GLOBAL_ZOBRIST: ZobristBuilder = ZobristBuilder {
    pieces_x: [
        [
            16437624894663622434,
            11613406684214096541,
            590340150759275968,
            2120890230325378574,
            11693316433680864202,
            12723414976750041395,
            13878262583366017333,
            1640606338885794740,
            8702620473209256940,
        ],
        [
            2311610056303275365,
            632777631852541574,
            15744524120631989643,
            8476824837892836492,
            17178992322412037086,
            15292550670146551813,
            9218393810596416620,
            5418357110386114101,
            11802173147888209255,
        ],
        [
            46570118936489059,
            5513388263847747576,
            12525154445411838185,
            16248497597458590152,
            3989996674882539278,
            16159054107833472007,
            9181658620945386499,
            13393058862440074541,
            12213251453868439217,
        ],
        [
            14328173617633926313,
            15975160707242500586,
            5883043683534290118,
            15086911982457316192,
            12366624002891237931,
            14201662359542935266,
            5251719817413584499,
            12764989362620871870,
            5386826673307719962,
        ],
        [
            4657150860972956113,
            7135063802282970336,
            14415550034322537407,
            17884503685996687784,
            17532652805898036482,
            13662259725704984370,
            4459446568696627128,
            8939663637467155743,
            17883920367720641317,
        ],
        [
            17529930222801765131,
            4201369244288515986,
            16104873953248531715,
            1009589831518884734,
            5523705765096820555,
            1995955659727298035,
            6819650351299027776,
            4767589996183172529,
            16786438502190917527,
        ],
        [
            17398307240075060022,
            814031722584972073,
            16283664520217301232,
            3388631340750138004,
            1244804183221606506,
            2478074917374466922,
            2880072563498065935,
            1155367051149819307,
            6556013425047188971,
        ],
        [
            8480591023874192631,
            17427210355960869662,
            7629413526608816624,
            13159037974743036163,
            15398116909273139634,
            8642653275063384125,
            13143839740725861431,
            5454391449286564392,
            569733393598070879,
        ],
        [
            8799168257551118019,
            1675773411468875443,
            13792740863089188316,
            5096452067761805709,
            2771125268289384227,
            1490296960195683958,
            4256501618264002496,
            15741912932399860378,
            2280307810456079262,
        ],
    ],
    pieces_o: [
        [
            6230907827980251653,
            14386015838438717923,
            5885305498766081780,
            14902017200234526152,
            13095990736292415559,
            13690310887339724101,
            104099016165171580,
            13507975646731491015,
            864809756944847596,
        ],
        [
            18137757558223361083,
            3563938084860631766,
            14913017224158081846,
            800970569733671511,
            16926691936934139363,
            13620951399498345068,
            15495844013377539578,
            5485270840365203648,
            12186821066105272022,
        ],
        [
            18016678094283267329,
            4027474006717334223,
            750034999851207022,
            12435417809391412145,
            9081936483653233900,
            11432930079848410271,
            9491931837386645198,
            17988953641903520203,
            16046021213211316561,
        ],
        [
            6302447484860017485,
            11467718418037908054,
            13675309612850510162,
            15232164681458490890,
            16465775007888582493,
            10576475755128515661,
            9706609248506189115,
            15206816045157317678,
            6706833475904718615,
        ],
        [
            4523347266416395735,
            10938865393675184410,
            15585033329908482940,
            1437002831303300001,
            8829300653665136445,
            6318780383101087585,
            6703123191284332189,
            53984947901768611,
            18301809088156765812,
        ],
        [
            1059412207119520113,
            219802895207230874,
            5285614923454864391,
            2760678803753719888,
            15453989033735255061,
            4259851408020958280,
            11914070306363090490,
            3113592477365213855,
            16962782269102271432,
        ],
        [
            10476430258121751044,
            9593555491420692692,
            14758448784627376,
            995615062867921114,
            15067385766269042202,
            5501763583868843237,
            15811221152212836372,
            17308361400460448682,
            4638149461738218118,
        ],
        [
            11939968852961672864,
            7912036750183294455,
            15433497120174690124,
            17432851031042440,
            9736507853928065313,
            1441361454490302826,
            8070851055436451454,
            13720716854461251505,
            5331567149471862841,
        ],
        [
            15058175302878983605,
            11893796471489331973,
            7329810053252628513,
            11202684655314775055,
            11515902559181548346,
            17844202259789864659,
            4260276884824947036,
            12624974086487266188,
            5123781290169781608,
        ],
    ],
    active: [
        2823528716564650922,
        4669411802000886612,
        16095169877683473188,
        16834831843342275595,
        15322678844230607302,
        9915542636514913674,
        1212619258276749692,
        5542823937874342900,
        3920431301796663292,
        4469868063162241266,
    ],
    x_turn: 7897597460396843402,
};

impl ZobristBuilder {
    pub fn new() -> Self {
        // {x, o} * 81 squares
        let pieces_x: [[u64; 9]; 9] = rand::random();
        let pieces_o: [[u64; 9]; 9] = rand::random();
        let active: [u64; 10] = rand::random();
        let x_turn: u64 = rand::random();

        ZobristBuilder {
            pieces_x,
            pieces_o,
            active,
            x_turn,
        }
    }

    pub fn hash(&self, game: &Game, turn: Slot) -> u64 {
        let mut hash = 0;

        // TODO: SIMD
        for (i, brd) in game.boards.iter().enumerate() {
            let mut bd = brd.0 & X_MASK;

            while bd != 0 {
                let ix = bd.trailing_zeros();
                hash ^= self.pieces_x[i][ix as usize];

                bd &= bd - 1;
            }
        }

        for (i, brd) in game.boards.iter().enumerate() {
            let mut bd = (brd.0 & O_MASK) >> O_OFFS;

            while bd != 0 {
                let ix = bd.trailing_zeros();
                hash ^= self.pieces_o[i][ix as usize];

                bd &= bd - 1;
            }
        }

        if turn == Slot::X {
            hash ^= self.x_turn;
        }

        hash ^= self.active[game.active];

        hash
    }
}

impl Default for ZobristBuilder {
    fn default() -> Self {
        Self::new()
    }
}
